{% extends "base.html" %}

{% block content %}

<h3>VIOLATION DATA</h3>

{% if violations_data %}
    
    <!-- Toggle Buttons -->
    <button id="showRecentBtn" class="btn-small">Show Recent (5)</button>
    <button id="showAllBtn" class="btn-small">Show Full Table</button>

    <div class="table-container">
        <table id="violTable">
            <thead>
                <tr>
                    <th>Time of Violation</th>
                    <th>Saved as Snapshot.No</th>
                    <th>Type of Violation</th>
                </tr>
            </thead>
            <tbody>
                {% for row in violations_data %}
                <tr>
                    <td>{{ row['Time of Violation'] }}</td>
                    <td>{{ row['Saved as Snapshot.No'] }}</td>
                    <td>{{ row['Type of Violation'] }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

{% else %}
    <p class="info-text">No violation data recorded yet. Process a video on the 'View' page.</p>
{% endif %}

<div class="divider"></div>

<!-- FPS GRAPH -->
<h3>FPS GRAPH</h3>

<canvas id="fpsChart" height="200" style="width: 100%;"></canvas>

<div class="divider"></div>

<!-- PLOTS -->
<div class="plot-grid">

    <div class="plot-container">
        <h4>BAR GRAPH:</h4>
        {% if plot_paths and plot_paths.bar %}
            <img src="{{ url_for('static', filename=plot_paths.bar) }}?v={{ range(1, 1000) | random }}">
        {% else %}
            <p class="info-text">No data for bar graph.</p>
        {% endif %}
    </div>
    
    <div class="plot-container">
        <h4>LINE PLOT:</h4>
        {% if plot_paths and plot_paths.line %}
            <img src="{{ url_for('static', filename=plot_paths.line) }}?v={{ range(1, 1000) | random }}">
        {% else %}
            <p class="info-text">Not enough data for a time-series line plot.</p>
        {% endif %}
    </div>

</div>


<!-- ----------- JAVASCRIPT SECTION ----------- -->

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* -------------------- TABLE LOGIC -------------------- */
const table = document.getElementById("violTable").getElementsByTagName("tbody")[0];
const rows = Array.from(table.rows);

document.getElementById("showRecentBtn").onclick = () => {
    rows.forEach((r, i) => r.style.display = i >= rows.length - 5 ? "" : "none");
};

document.getElementById("showAllBtn").onclick = () => {
    rows.forEach(r => r.style.display = "");
};

// Default = show last 5
document.getElementById("showRecentBtn").click();


/* -------------------- FPS GRAPH -------------------- */
let ctx = document.getElementById("fpsChart").getContext("2d");

let fpsChart = new Chart(ctx, {
    type: "line",
    data: {
        labels: [],
        datasets: [{
            label: "FPS",
            data: [],
            fill: true,
            borderColor: "rgba(150, 0, 255, 1)",
            backgroundColor: "rgba(150, 0, 255, 0.3)",
            tension: 0.4,
            borderWidth: 3,
        }]
    },
    options: {
        plugins: { legend: { display: false } },
        scales: {
            x: {
                ticks: { color: "#fff" },
                border: { color: "#fff" }
            },
            y: {
                ticks: { color: "#fff" },
                border: { color: "#fff" }
            }
        }
    }
});

// Update graph every second
setInterval(async () => {
    const res = await fetch("/get_fps");
    const data = await res.json();

    fpsChart.data.labels = data.history.map((_, i) => i + 1);
    fpsChart.data.datasets[0].data = data.history;

    fpsChart.update();
}, 1000);
</script>

{% endblock %}
